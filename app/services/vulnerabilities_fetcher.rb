require "uri"
require "json"
require "net/http"
require "awesome_print"

# Vulnerability.destroy_all

QUERY = "
query($after: String) {
  securityVulnerabilities(first: 100, after: $after) {
    pageInfo {
      hasNextPage
      endCursor
    }
    totalCount
    nodes {
      vulnerableVersionRange
      firstPatchedVersion {
        identifier
      }
      package {
        name
      }
      advisory {
        description
        ghsaId
        permalink
        summary
        publishedAt
      }
      severity
    }
  }
}
"
class VulnerabilitiesFetcher
  def initialize; end

  def call
    cursor = nil
    cursors = []
    loop do
      response = request(cursor)
      ap cursor = response.dig("data", "securityVulnerabilities", "pageInfo", "endCursor")
      cursors << cursor
      ap has_next_page = response.dig("data", "securityVulnerabilities", "pageInfo", "hasNextPage")
      vulnerabilities = response.dig("data", "securityVulnerabilities", "nodes")
      upsert_vulnerabilities(vulnerabilities)
      break unless has_next_page
    end
    ap cursors.size
  end

  private

  def upsert_vulnerabilities(vulnerabilities)
    vulnerabilities.each do |v|
      if Vulnerability.where(summary: v["summary"]).exists?
        v.update
        ap "OK update"
      else
        new_summary = v["advisory"]["summary"] # summary
        new_details = v["advisory"]["description"] # details
        new_stack = v["package"]["name"] # stack
        Vulnerability.create!(summary: new_summary, details: new_details, stack: new_stack)
        ap "Vuln create"
      end
    end
  end

  def request(cursor)
    uri    = URI("https://api.github.com/graphql")
    params = { query:     QUERY,
               variables: { after: cursor } }

    headers = {
      "Authorization" => "Bearer #{ENV['GITHUB_TOKEN']}",
      "Content-Type"  => "application/json",
      "Accept"        => "application/json"
    }
    http         = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true
    response     = http.post(uri.path, params.to_json, headers)
    JSON.parse(response.body)
  end
end
