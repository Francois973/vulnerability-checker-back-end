class GetRepositoriesUserService
  HEADER = {
    'Authorization': "Bearer #{ENV['GITHUB_TOKEN']}"
  }.freeze

  def initialize(username)
    @username = username
  end

  def call
    uri = URI("https://api.github.com")

    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true

    response = http.get("/users/#{@username['username']}/repos", HEADER)
    if response.code == "200"
      repositories = JSON.parse(response.body)
      format_repositories(repositories)
    else
      puts "Failed with status code #{response.code}"
    end
  end

  private

  def format_repositories(results)
    repositories = {
      owner:        results[0]["owner"]["login"],
      repositories: []
    }

    results.each do |repositorie|
      repositories[:repositories] << {
        name:      repositorie["name"],
        url:       repositorie["html_url"],
        languages: get_languages(repositorie["name"], @username["username"])
      }
    end
    repositories
  end

  def get_languages(name, username)
    uri = URI("https://api.github.com")

    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true

    response = http.get("/repos/#{username}/#{name}/languages", HEADER)
    JSON.parse(response.body)
  end
end
