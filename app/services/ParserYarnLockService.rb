class ParserYarnLockService
  def initialize(file_content)
    @file_content = file_content
  end

  def call
    if @file_content.starts_with?("# THIS IS AN AUTOGENERATED FILE.")
      parse_yarn_lock
    else
      parse_package_lock
    end
  end

  def parse_yarn_lock
    file = Tempfile.new("yarn.lock")
    file.write(@file_content)
    file.close
    parsed = YarnLockParser::Parser.parse(file.path)
    arr_specs = []
    parsed.each do |spec|
      arr_specs << {
        name:    spec[:name],
        version: Gem::Version.new(spec[:version])
      }
    end
  ensure
    file.unlink
    return arr_specs
  end

  def parse_package_lock
    file = JSON.parse(@file_content)
    arr_specs = []
    file["packages"][""]["dependencies"].each do |key, value|
      arr_version = value.chars
      arr_version[0] = ""
      version = arr_version.join.strip
      arr_specs << {
        name:    key,
        version: Gem::Version.new(version)
      }
    end
    arr_specs
  end
end
