class VulnerabilitiesFinderService
  def initialize(array_specs, ecosystem)
    @array_specs = array_specs
    @ecosystem = ecosystem
  end

  attr_reader :array_specs, :ecosystem

  def call
    detected_vulnerabilities = []
    array_specs.each do |spec|
      vulnerabilities = Vulnerability.where(stack: spec[:name], ecosystem:)
      next unless vulnerabilities.any?

      vulnerabilities.each do |vulnerability|
        detected_vulnerabilities << vulnerability if match_version?(vulnerability, spec)
      end
    end
    detected_vulnerabilities.uniq
  end

  private

  def match_version?(vulnerability, spec)
    vulnerability.version_ranges.all? do |version|
      spec_version = Gem::Version.new(spec[:version])
      vulnerability_version = Gem::Version.new(version["version"])
      comparator = version["comparator"]
      spec_version.public_send(comparator, vulnerability_version)
    end
  end
end
