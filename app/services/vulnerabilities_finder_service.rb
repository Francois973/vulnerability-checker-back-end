class VulnerabilitiesFinderService
  attr_reader :arr_specs

  def initialize(arr_specs)
    @arr_specs = arr_specs
  end

  def call
    @project = Project.last
    vulnerabilities_found = []
    arr_specs.each do |spec|
      vulnerability = Vulnerability.find_by(stack: spec[:name], ecosystem: "RUBYGEMS")
      next unless vulnerability

      vulnerabilities_found << vulnerability if match_version?(vulnerability, spec)
    end
    VulnerabilitiesProjectService.new(vulnerabilities_found, @project).call
  end

  private

  def match_version?(vulnerability, spec)
    vulnerability.version_ranges.all? do |version|
      spec_version = Gem::Version.new(spec[:version])
      vulnerability_version = Gem::Version.new(version["version"])
      comparator = version["comparator"]
      spec_version.public_send(comparator, vulnerability_version)
    end
  end
end
