require "test_helper"
require 'pry-byebug'
require 'net/http'

class VulnerabilityCheckerJobTest < ActiveJob::TestCase
  include ActionCable::TestHelper

  test "should catch a gemfile" do
    stub_request(:get, "https://raw.githubusercontent.com/whoever/whatever/master/Gemfile.lock").
      to_return(status: 200, body: file_fixture("Gemfile_valid.lock").read)

    stub_request(:get, "https://raw.githubusercontent.com/whoever/whatever/master/mix.lock").
      to_return(status: 404, body: "")

    stub_request(:get, "https://raw.githubusercontent.com/whoever/whatever/master/php.lock").
      to_return(status: 404, body: "")

    stub_request(:get, "https://raw.githubusercontent.com/whoever/whatever/master/py.lock").
      to_return(status: 404, body: "")

    project = Project.create(url: "https://github.com/whoever/whatever", name: "whoever")
    VulnerabilityCheckerJob.perform_now(project.id)
    assert_enqueued_with(job: VulnerabilityFinderJob, args: [project.id, "RUBYGEMS", file_fixture("Gemfile_valid.lock").read])
    project.reload
    assert_equal project.ecosystems, {"PHP"=>"unavailable", "ERLANG"=>"unavailable", "PYTHON"=>"unavailable", "RUBYGEMS"=>"scanning"}

    assert_broadcast_on(ProjectChannel.broadcasting_for(project), { "type" => "ecosystem:update",  "payload"=> { "ERLANG"=>"pending", "PYTHON"=>"pending", "PHP"=>"pending", "RUBYGEMS"=>"scanning" }})
    assert_broadcast_on(ProjectChannel.broadcasting_for(project), { "type" => "ecosystem:update", "payload" => { "PHP"=>"unavailable", "ERLANG"=>"unavailable", "PYTHON"=>"unavailable", "RUBYGEMS"=>"scanning" }})
  end
end
