require "test_helper"

class VulnerabilityFinderJobTest < ActiveJob::TestCase
  include ActionCable::TestHelper

  test "should find vulnerability in gemfile.lock" do
    project = Project.create(url: "https://github.com/whoever/whatever")

    actioncable_vulnerability = Vulnerability.create!(
      stack: "actioncable",
      summary: "test",
      details: "test",
      version_ranges: [{version: "6.1.4", comparator: "<"}],
      ecosystem: "RUBYGEMS"
    )

    rexml_vulnerability = Vulnerability.create!(
      stack: "rexml",
      summary: "test",
      details: "test",
      version_ranges: [{version: "3.2.0", comparator: ">"}, {version: "3.3.0", comparator: "<="}],
      ecosystem: "RUBYGEMS"
    )

    VulnerabilityFinderJob.perform_now(project.id, "RUBYGEMS", file_fixture("Gemfile_invalid.lock").read)
    project.reload

    assert_equal project.vulnerabilities.length, 2
    assert_equal project.vulnerabilities.map(&:stack), ["actioncable", "rexml"]

    options = {serializer: VulnerabilitySerializer}
    actioncable_vulnerability_json = ActiveModelSerializers::SerializableResource.new(actioncable_vulnerability, options).as_json
    rexml_vulnerability_json = ActiveModelSerializers::SerializableResource.new(rexml_vulnerability, options).as_json

    assert_broadcast_on(ProjectChannel.broadcasting_for(project), { "type" => "vulnerability:found", "payload" => actioncable_vulnerability_json})
    assert_broadcast_on(ProjectChannel.broadcasting_for(project), { "type" => "vulnerability:found", "payload" => rexml_vulnerability_json})
  end
end
