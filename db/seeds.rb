Vulnerability.destroy_all
Project.destroy_all

10.times do
  Project.new(name: Faker::Company.name, public: false, status: "New")
end

QUERY = "
  query($after: String) {
    securityVulnerabilities(first: 100, after: $after) {
      pageInfo {
        endCursor
      }
      totalCount
      nodes {
        vulnerableVersionRange
        firstPatchedVersion {
          identifier
        }
        package {
          name
        }
        advisory {
          description
          ghsaId
          permalink
          summary
          publishedAt
        }
        severity
      }
    }
  }
  "

def fetch(cursor)
  call_github(cursor)
end

params = QUERY["securityVulnerabilities"]["pageInfo"]

fetch(params)

def call_github(cursor)
  ends_cursor = []
  92.times do
    uri    = URI("https://api.github.com/graphql")
    params = { query:     QUERY,
               variables: { after: cursor } }
    # p afterexit
    headers = {
      "Authorization" => "Bearer #{ENV['GITHUB_TOKEN']}",
      "Content-Type"  => "application/json",
      "Accept"        => "application/json"
    }
    http         = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true
    response     = http.post(uri.path, params.to_json, headers)
    data         = JSON.parse(response.body)
    # binding.pry
    cursor       = data["data"]["securityVulnerabilities"]["pageInfo"]["endCursor"]
    datas        = data["data"]["securityVulnerabilities"]["nodes"]

    find_datas(datas)
    ap cursor

    ends_cursor.push(cursor)
    # ap ends_cursor
    ap ends_cursor.size
    ap "Page vluns created !"
  end
end

def find_datas(datas)
  datas.each do |el|
    # binding.pry
    # ap el["severity"] # severity
    new_summary = el["advisory"]["summary"] # summary
    new_details = el["advisory"]["description"] # details
    new_stack = el["package"]["name"] # stack
    ap Vulnerability.create!(summary: new_summary, details: new_details, stack: new_stack)
  end
end
